{% extends "base.html" %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Document</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
crossorigin=""></script>
<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        width: 100%;
        height: 70%;
    }
</style>
{% endblock %}

{% block content %}
<style>
  div {
    display: inline-block
  }
  </style>

<fieldset >
  <div>
    <legend>Choose your interests</legend>
    <ul id="test">
    {% for countValue, districtarray in datadistricts.items() %} 
    <li>
      <input type="checkbox">
      <label class="custom-unchecked">{{countValue}} (можно развернуть)</label>
      <ul id="{{countValue}}" hidden="hidden">
      {% for district in districtarray %} 
      <li class="inner">
        <input type="checkbox" class="inner" id="{{district}}">
        <label for="{{countValue}}-{{loop.index}}" class="custom-unchecked">{{district}}</label>
      </li>
      {% endfor %}
      </ul>
    </li>
    {% endfor %}
    </ul>
    <form>
        <fieldset>
          <legend>Выберите тип зданий</legend>
          <div>
            <input type="radio" id="contactChoice1" name="buldtype" value="0" />
            <label for="contactChoice1">Школы</label>
            <input type="radio" id="contactChoice2" name="buldtype" value="3" />
            <label for="contactChoice2">Детские сады</label>
            <input type="radio" id="contactChoice3" name="buldtype" value="1" />
            <label for="contactChoice3">Мед учреждения</label>
            <input type="radio" id="contactChoice4" name="buldtype" value="2" />
            <label for="contactChoice4">Жилые здания</label>
          </div>
        </fieldset>
      </form>
    <button onclick="getstatistics();" name="button" id="newButton" >Press me</button>
  </div>
  <div>
    <div id="map" ></div>
    <button onclick="toggle(this);">Hide list</button>
    <button onclick="clearLayer(this);">Clear</button>
    <input type="text" id="lon" placeholder="lon">
    <input type="text" id="lat" placeholder="lat">
    <button onclick="radius(this);">Радиус доступности</button>
  </div>
  </fieldset>
  {% endblock %}

  {% block scripts %}
  <h1>Bye, {{user}}</h1>
  
  <p></p>
  <script>
    function getEventTarget(e) {
    e = e || window.event;
    return e.target || e.srcElement; 
    }
  
    var ul = document.getElementById('test');
    ul.onclick = function(event) {
    var target = getEventTarget(event);
    let elemID = target.innerText;
    let cleanID = elemID.substring(0, elemID.length - 19);
    let element = document.getElementById(cleanID);
    //alert(cleanID)
    if (element){
    let hidden = element.getAttribute("hidden");
  
    if (hidden) {
    element.removeAttribute("hidden");
    } else {
    element.setAttribute("hidden", "hidden");
    }
    //alert(target.innerText);
    }
  };
  </script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script src="{{url_for('static', filename='main.js')}}"></script>
<script>
  function getstatistics(){
    let cusid_ele = document.getElementsByClassName('inner');
    let districtsArray = [];
    for (var i = 0; i < cusid_ele.length; ++i) {
        var item = cusid_ele[i]; 
        if (item.checked){
          districtsArray.push(item.id);
        } 
    }
    if(districtsArray.length == 0){
        alert('Районы не выбраны');
        return;
    };
    builddatabaseCheck = document.querySelector('input[name="buldtype"]:checked');
    if (!builddatabaseCheck){
        alert('Тип зданий не выбран');
        return;
    };
    clearlayer();
    //если нет районов - возврат
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "POST", 'http://127.0.0.1:5000/districtsfullinfo', false ); // false for synchronous request
    let body = JSON.stringify({
          "IDsource": districtsArray
      });
      xmlHttp.send(body);
      textJSON = xmlHttp.responseText;
      drawdisricts(textJSON);
    
    builddatabase = builddatabaseCheck.value;
    
      xmlHttp.open( "POST", 'http://127.0.0.1:5000/buildingfullinfo', false ); // false for synchronous request
       body = JSON.stringify({
          "IDsource": districtsArray,
          "isCount": false,
          "database": parseInt(builddatabase)
      });
      xmlHttp.send(body);
      textJSON = xmlHttp.responseText;
      drawLiving(textJSON, builddatabase);

    
  };
  function drawdisricts(textJSON){
    addBordersToMap(textJSON);
    controlsLayer.addOverlay(GeoJson,"Границы районов").expand();
    map_init.addLayer(GeoJson);
    overLayers.push(GeoJson);
    addDistrictsToMap(textJSON);
    controlsLayer.addOverlay(GeoJson,"Районы").expand();
    map_init.addLayer(GeoJson);
    overLayers.push(GeoJson);
  };
  function getAttrBase(number){
    innerDict = {
        0: ['Школы', 'Название'],
        1: ['Медицина', ''],
        2: ['Жилые здания', 'Адрес'],
        3: ['Детские сады', 'Название']
    }
    return innerDict[number]
  }
</script>
<script>
function addDistrictsToMap(text){
      const res = JSON.parse(text);
      GeoJson = L.geoJson(res, {
          onEachFeature: function (feature, layer) {
              layer.myTag = "myGeoJSON"
              layer.setStyle({
                color :'green',
                opacity: 0.5,
                weight: 0,
            })
      }}).bindPopup(function (layer) {
          return String(layer.feature.properties.nameDistrict);
      }).addTo(map_init);
  };
  function addBordersToMap(text){
      const res = JSON.parse(text);
      GeoJson = L.geoJson(res, {
          onEachFeature: function (feature, layer) {
              layer.myTag = "myGeoJSON"
              layer.setStyle({
                color :'black',
                fillOpacity: 0.0,
                weight: 1,
            })
      }}).bindPopup(function (layer) {
          return String(layer.feature.properties.nameDistrict);
      }).addTo(map_init);
  };
  function clearlayer(){
      map_init.eachLayer( function(layer) {
          if ( layer.myTag &&  layer.myTag === "myGeoJSON") {
          map_init.removeLayer(layer)
          }
      }); 
      overLayers.forEach(function(entry) {
        controlsLayer.removeLayer(entry);
    });
      
  };
  function addInfoAvailRinCard(newlon, newlat){
      return "<button onclick='availRfromCard(this);'>Clear</button><label id='hiddencoordinates' hidden>" + newlat + ',' + newlon + "</label>"
  }
  
  function drawLiving(textJSON, builddatabase){
      const res = JSON.parse(textJSON);
      features = getAttrBase(builddatabase);
      main_feature = features[1];
      let newlon = 0.0
      let newlat = 0.0
      
  
      var GeoJson = L.geoJson(res, {
          onEachFeature: function (feature, layer) {
              layer.myTag = "myGeoJSON";
              stringTable = '';
              main_value = '';
              if (feature.properties){
                  for(key in feature.properties){
                      if (key != main_feature){
                          if (key != 'Широта') {
                              if (key != 'Долгота'){
                                  stringTable += '<tr><td>' + key + '</td><td>' + feature.properties[key] + '</td></tr>'
                              }else{
                                  newlon = feature.properties[key];
                              }
                          }else{
                              newlat = feature.properties[key];
                          }
                      
                  }else{
                      main_value = feature.properties[key];
                  }}
              }
              layer.bindTooltip(main_value);
              popupText = '<h1>' + main_value + "</h1><table border='1' style='width:400px;'>" + stringTable + "</table>"
              if (builddatabase != 2){
                popupText += addInfoAvailRinCard(newlon, newlat)
              }
              layer.bindPopup(popupText, { maxWidth : 410});
      }})//.bindPopup(function (layer) {
         // return String(layer.feature.properties.adress);
      //})
      //.addTo(map_init);
    controlsLayer.addOverlay(GeoJson,features[0]).expand();
    map_init.addLayer(GeoJson);
    controlsLayer._update();
    overLayers.push(GeoJson);

  }
  function getnewradius(lon, lat, radius){
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open( "POST", 'http://127.0.0.1:5000/nearcoordinates', false ); // false for synchronous request
      let body = JSON.stringify({
          "lat": lat,
          "lon": lon
      });
      var circle = L.circle([lat, lon], {
      color: "red",
      fillColor: "#f03",
      fillOpacity: 0.5,
      radius: radius
      });
      circle.myTag = "myGeoJSON";
      circle.addTo(map_init);
      xmlHttp.send(body);
      resp = xmlHttp.responseText;
      drawLiving(resp);
  };
  var map_init = L.map('map',{
      center: [55.703598577482609, 37.938057458250945],
      zoom:8
  });
  var osm = L.tileLayer ('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo (map_init);
      //var marker = L.marker([55.703598577482609, 37.938057458250945]).addTo(map_init);
      //var marker1 = L.marker([9.0822, 8.6755]).addTo(map_init);
      //var polygonPoints = [[ 37.938764987543998, 55.703689508653 ], [ 37.938224572194997, 55.703214829175003 ], [ 37.938093441904002, 55.703131983780999 ], [ 37.937938470009001, 55.703217068371998 ], [ 37.937243082111003, 55.703669357319001 ], [ 37.936543720830002, 55.703268566913998 ], [ 37.936309275985003, 55.703384998033997 ], [ 37.936305302439997, 55.703456647807997 ], [ 37.937131819973999, 55.703946997422001 ], [ 37.937350370569, 55.703949236485002 ], [ 37.937406001522, 55.703989538899997 ], [ 37.938558358012003, 55.704009690115001 ], [ 37.938649751861, 55.703964909642998 ], [ 37.938840486651998, 55.703964909642998 ], [ 37.939726609013, 55.703492472691998 ], [ 37.939710714501999, 55.703432018261999 ], [ 37.939472295850003, 55.703302152816001 ], [ 37.938764987543998, 55.703689508653 ] ];
  //var poly = L.polygon(polygonPoints).addTo(map_init);
  
  var Basemaps = {
      "OSM": osm
  }
  
  let controlsLayer = L.control.layers(Basemaps);
  controlsLayer.addTo (map_init);
  let overLayers = [];
  let toggle = button => {
      var resp = httpGet();
      //alert(resp);
      drawLiving(resp);
  //res.forEach(function(state){
  //    if (state.geometry.type == 'Point') return;
  //    console.log(state.geometry.type)
  //    var polygon = L.polygon(state.geometry.coordinates).addTo(map_init);
  //});
  };
  
  let clearLayer = button => {
      clearlayer();
  };
  
  let availRfromCard = button => {
      var fields = document.getElementById('hiddencoordinates').textContent.split(',');
      var fValuelat = parseFloat(fields[0]);
      var fValuelon = parseFloat(fields[1]);
      clearlayer();
      getnewradius(fValuelon, fValuelat, 500);
  };
  
  let radius = button => {
      var fValuelon = parseFloat(document.getElementById("lon").value.replace(",","."))
      fValuelon = 37.93
      var fValuelat = parseFloat(document.getElementById("lat").value.replace(",","."))
      fValuelat = 55.7
      getnewradius(fValuelon, fValuelat, 500);
  }
  </script>
    
  <script>
      function httpGet(theUrl)
  {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open( "POST", 'http://127.0.0.1:5000/buildingfullinfo', false ); // false for synchronous request
      let body = JSON.stringify({
          "IDsource": ["район Ивановское"],
          "isCount": false,
          "database": 2
      });
      xmlHttp.send(body);
      return xmlHttp.responseText;
  };
  </script>
  
{% endblock %}
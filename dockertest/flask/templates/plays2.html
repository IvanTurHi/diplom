<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 50%;
            height: 50vh;
        }
    </style>
</head>
<body>

    <div id="map" ></div>
    <button onclick="toggle(this);">Hide list</button>
    <button onclick="clearLayer(this);">Clear</button>
    <input type="text" id="lon" placeholder="lon">
    <input type="text" id="lat" placeholder="lat">
    <button onclick="radius(this);">Радиус доступности</button>
</body>
<script>

function addtextgeoJsonToMap(text){
    const res = JSON.parse(text);
    GeoJson = L.geoJson(res, {
        onEachFeature: function (feature, layer) {
            layer.myTag = "myGeoJSON"
    }}).bindPopup(function (layer) {
        return String(layer.feature.properties.adress);
    }).addTo(map_init);
};
function clearlayer(){
    map_init.eachLayer( function(layer) {
        if ( layer.myTag &&  layer.myTag === "myGeoJSON") {
        map_init.removeLayer(layer)
        }
    }); 
};
function addInfoAvailRinCard(newlon, newlat){
    return "<button onclick='availRfromCard(this);'>Clear</button><label id='hiddencoordinates' hidden>" + newlat + ',' + newlon + "</label>"
}

function drawLiving(textJSON){
    const res = JSON.parse(textJSON);

    main_feature = 'Адрес'
    let newlon = 0.0
    let newlat = 0.0

    GeoJson = L.geoJson(res, {
        onEachFeature: function (feature, layer) {
            layer.myTag = "myGeoJSON";
            stringTable = '';
            main_value = '';
            if (feature.properties){
                for(key in feature.properties){
                    if (key != main_feature){
                        if (key != 'Широта') {
                            if (key != 'Долгота'){
                                stringTable += '<tr><td>' + key + '</td><td>' + feature.properties[key] + '</td></tr>'
                            }else{
                                newlon = feature.properties[key];
                            }
                        }else{
                            newlat = feature.properties[key];
                        }
                    
                }else{
                    main_value = feature.properties[key];
                }}
            }
            layer.bindTooltip(main_value);
            layer.bindPopup('<h1>' + main_value + "</h1><table border='1' style='width:500px;'>" + stringTable + "</table>" + addInfoAvailRinCard(newlon, newlat), { maxWidth : 560});
    }})//.bindPopup(function (layer) {
       // return String(layer.feature.properties.adress);
    //})
    .addTo(map_init);
}
function getnewradius(lon, lat, radius){
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "POST", 'http://127.0.0.1:5000/nearcoordinates', false ); // false for synchronous request
    let body = JSON.stringify({
        "lat": lat,
        "lon": lon
    });
    var circle = L.circle([lat, lon], {
    color: "red",
    fillColor: "#f03",
    fillOpacity: 0.5,
    radius: radius
    });
    circle.myTag = "myGeoJSON";
    circle.addTo(map_init);
    xmlHttp.send(body);
    resp = xmlHttp.responseText;
    drawLiving(resp);
};
var map_init = L.map('map',{
    center: [55.703598577482609, 37.938057458250945],
    zoom:8
});
var osm = L.tileLayer ('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo (map_init);
    //var marker = L.marker([55.703598577482609, 37.938057458250945]).addTo(map_init);
    //var marker1 = L.marker([9.0822, 8.6755]).addTo(map_init);
    //var polygonPoints = [[ 37.938764987543998, 55.703689508653 ], [ 37.938224572194997, 55.703214829175003 ], [ 37.938093441904002, 55.703131983780999 ], [ 37.937938470009001, 55.703217068371998 ], [ 37.937243082111003, 55.703669357319001 ], [ 37.936543720830002, 55.703268566913998 ], [ 37.936309275985003, 55.703384998033997 ], [ 37.936305302439997, 55.703456647807997 ], [ 37.937131819973999, 55.703946997422001 ], [ 37.937350370569, 55.703949236485002 ], [ 37.937406001522, 55.703989538899997 ], [ 37.938558358012003, 55.704009690115001 ], [ 37.938649751861, 55.703964909642998 ], [ 37.938840486651998, 55.703964909642998 ], [ 37.939726609013, 55.703492472691998 ], [ 37.939710714501999, 55.703432018261999 ], [ 37.939472295850003, 55.703302152816001 ], [ 37.938764987543998, 55.703689508653 ] ];
//var poly = L.polygon(polygonPoints).addTo(map_init);

var Basemaps = {
    "OSM": osm
}

L.control.layers (Basemaps).addTo (map_init);

let toggle = button => {
    var resp = httpGet();
    //alert(resp);
    drawLiving(resp);
//res.forEach(function(state){
//    if (state.geometry.type == 'Point') return;
//    console.log(state.geometry.type)
//    var polygon = L.polygon(state.geometry.coordinates).addTo(map_init);
//});
};

let clearLayer = button => {
    clearlayer();
};

let availRfromCard = button => {
    var fields = document.getElementById('hiddencoordinates').textContent.split(',');
    var fValuelat = parseFloat(fields[0]);
    var fValuelon = parseFloat(fields[1]);
    clearlayer();
    getnewradius(fValuelon, fValuelat, 500);
};

let radius = button => {
    var fValuelon = parseFloat(document.getElementById("lon").value.replace(",","."))
    fValuelon = 37.93
    var fValuelat = parseFloat(document.getElementById("lat").value.replace(",","."))
    fValuelat = 55.7
    getnewradius(fValuelon, fValuelat, 500);
}
</script>
  
<script>
    function httpGet(theUrl)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "POST", 'http://127.0.0.1:5000/buildingfullinfo', false ); // false for synchronous request
    let body = JSON.stringify({
        "IDsource": "район Ивановское",
        "isCount": false,
        "database": 2
    });
    xmlHttp.send(body);
    return xmlHttp.responseText;
};
</script>

</html>